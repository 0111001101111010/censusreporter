{% extends '_base_compare.html' %}{% load humanize %}

{% block content %}

<article id="comparison-distribution" class="clearfix">
    <header class="section-contents">
        <h1>Map</h1>
    </header>
    <div class="section-container">
        <section class="clearfix">
            <div class="tool-set">
                <div class="tool-group" id="map-select">
                    Show
                </div>
                <div class="tool-group" id="map-legend">
                    <ul class="quantile-legend">
                        <li class="q0"></li>
                        <li class="q1">
                            <span class="quantile-label"></span>
                        </li>
                        <li class="q2">
                            <span class="quantile-label"></span>
                        </li>
                        <li class="q3">
                            <span class="quantile-label"></span>
                        </li>
                        <li class="q4">
                            <span class="quantile-label"></span>
                        </li>
                    </ul>
                </div>
            </div>

            <h2>{{ table.table_name }}</h2>
            <aside>
            </aside>

            <section id="data-map"></section>

        </section>
    </div>
</article>
{% endblock %}

{% block body_javascript_extra %}
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>
var mapDiv = d3.select("#data-map").append("div")
    .attr("class", "svg-map")
    
var width = mapDiv[0][0].offsetWidth,
    height = width*.67;

var state_fips_code = {{ parent_fips_code }};

var projection = d3.geo.mercator();
if (state_fips_code == '02' || state_fips_code == '15') {
    projection = d3.geo.albersUsa();
}

var path = d3.geo.path()
    .projection(projection);

var svgMap = mapDiv.append("svg")
    .attr("width", width)
    .attr("height", height)
    .style("position", "relative");

var label = mapDiv.append("div")
    .attr("class", "label")
    .style("opacity", 1e-6);
    
var labelTitle = "";
    
queue()
    .defer(d3.json, "{{ STATIC_URL }}json/us.json")
    .await(ready);

function ready(error, geographies) {
    var geodata = {{ map_data }},
        tabledata = {{ table_data }};
    var columns = d3.entries(tabledata['columns']);

    // add dropdown
    d3.select("#map-select").append("select")
        .attr("id", "map-select-select")
        .on("change", changeMap)
    .selectAll("option").data(columns).enter().append("option")
        .attr("value", function(d){ return d['key']; })
        .text(function(d){
                var indents = new Array(d['value']['indent']);
                return indents.join("\xA0\xA0") + d['value']['name'];
            })
    
    makeMap(geographies, geodata[columns[0]['key']]);
    window.labelTitle = columns[0]['value']['name'];
    
    function changeMap() {
        var dataIndex = this.options[this.selectedIndex].value;
        window.labelTitle = tabledata['columns'][dataIndex]['name'];
        makeMap(geographies, geodata[dataIndex]);
    }
}

function makeMap(geographies, geodata) {
    var values = d3.values(geodata).map(function(d) {return d['percentage'];});
    var quantize = d3.scale.quantile()
        .domain([d3.min(values), d3.max(values)])
        .range(d3.range(5).map(function(i) { return "q" + i; }));
        
    var legendLabels = d3.select("#map-legend")
        .selectAll("span")
        .data(quantize.quantiles())
        .text(function(d){ return d.toFixed(1) + '%' });

    var states = topojson.feature(geographies, geographies.objects.states),
        parent = states.features.filter(function(d) {
            return d.id === {{ parent_fips_code }};
        })[0];

    var counties = topojson.feature(geographies, geographies.objects.counties),
        geographies = counties.features.filter(function(d) {
            var id = d.id.toString(); return id.substring(0,2) === '{{ parent_fips_code }}';
        });

    // zoom to the state
    projection
        .scale(1)
        .translate([0, 0]);

    var b = path.bounds(parent),
        s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

    projection
        .scale(s)
        .translate(t);
    
    // put the map in place
    svgMap.append("g")
            .attr("class", "geographies")
        .selectAll("path")
            .data(geographies)
        .enter().append("path")
            .attr("d", path)
            .attr("id", function(d) { return "poly-" + d['id']; })
            .attr("class", function(d) { 
                if (!!geodata[d['id']]) {
                    return quantize(geodata[d['id']]['percentage']);
                }
            })
            .on("mouseover", function(d) { return mouseover(d) })
            .on("mousemove", mousemove)
            .on("mouseout", mouseout);

    function mouseover(d) {
        if (!!geodata[d['id']]) {
            var centroid = path.centroid(d),
                x = centroid[0],
                y = centroid[1];

            label
                .html(makeLabel(d))
                .transition()
                .duration(200)
                .style("width", "200px")
                .style("opacity", 1);
                //.style("left", x + "px")
                //.style("top", y + "px");
        }
    }

    function mousemove() {
        label
            .style("left", (d3.mouse(this)[0] - 100) + "px")
            .style("bottom", height-(d3.mouse(this)[1] - 12) + "px");
    }

    function mouseout() {
        label.transition()
            .duration(200)
            .style("opacity", 1e-6);
    }
    
    function makeLabel(d) {
        if (!!geodata[d['id']]) {
            var label = "<span class='label-title'>" + labelTitle + "</span>";
            label += "<span class='name'>" + geodata[d['id']]['name'] + "</span>";
            if (!!geodata[d['id']]['percentage']) {
                label += "<span class='value'>" + geodata[d['id']]['percentage'] + "%";
                if (!!geodata[d['id']]['number']) {
                    label += " (" + numberWithCommas(geodata[d['id']]['number']) + ")";
                }
                label += "</span>";
            }
            else if (!!geodata[d['id']]['number']) {
                label += "<span class='value'>" + geodata[d['id']]['number'] + "</span>";
            }
        }
        return label
    }

    function numberWithCommas(n) {
        var parts=n.toString().split(".");
        return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + (parts[1] ? "." + parts[1] : "");
    }    
    //svg.selectAll(".label")
        //    .data(geographies.features)
        //.enter().append("text")
        //    .attr("id", function(d) { return "label-" + d['id']; })
        //    .attr("class", "label")
        //    .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
        //    .text(function(d) { return d['properties']['name'] + geodata[d['id']]; });
}

</script>
{% endblock %}
