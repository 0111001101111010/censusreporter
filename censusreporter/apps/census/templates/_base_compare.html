{% extends '_base.html' %}

{% block head_title %}{% firstof comparison_metadata.descendant_type.plural|capfirst comparison_metadata.descendant_type.name %} in {{ comparison_metadata.parent_geography.geography.name }} - Comparison - {{ block.super }}{% endblock %}

{% block header_content %}
<section id="query-builder-bar" class="clearfix">
    <div id="query-topic" class="query-chosen">
        <h3 class="leader">Topic</h3>
        Table {{ table.table_id }}
    </div>
    <section class="clearfix" id="query-topic-picker">
        <div class="column-quarter filter-groups">
            <h2>Filter by topic</h2>
            {% include "_compare/_compare_builder_topic_filter_list.html" with filter_list=topic_demographic_filters filter_list_name="Demographics" %}
            {% include "_compare/_compare_builder_topic_filter_list.html" with filter_list=topic_economic_filters filter_list_name="Economic" %}
            {% include "_compare/_compare_builder_topic_filter_list.html" with filter_list=topic_family_filters filter_list_name="Families" %}
            {% include "_compare/_compare_builder_topic_filter_list.html" with filter_list=topic_housing_filters filter_list_name="Housing" %}
            {% include "_compare/_compare_builder_topic_filter_list.html" with filter_list=topic_social_filters filter_list_name="Social" %}
        </div>

        <div class="column-three-quarters autocomplete-widget">
            <h2 id="topic-result-number">Search data tables</h2>
            <input name="topic_select" id="topic-select" type="text" placeholder="Search for data..." autocomplete="off">
        </div>
    </section>
    
    <div id="query-geographies" class="query-chosen">
        <h3 class="leader">Geographies</h3>
        {{ comparison_metadata.child_geography_name_plural|capfirst }} in {{ comparison_metadata.parent_name }}
    </div>
    <section class="clearfix" id="query-geography-picker">
        <div class="column-quarter filter-groups">
            <h2>Compare geographies</h2>
            <div class="select-wrapper">
                <i class="icon-chevron-sign-down"></i>
                <select id="sumlev-select-options" class="wide-picker" name="sumlev_select">
                    <option value="">Choose a comparison level...</option>
                    {% for group, values in sumlev_choices.items %}
                    <optgroup label="{{ group }}">
                        {% for sumlev in values %}
                        <option id="sumlev-select-{{ sumlev.summary_level }}" value="{{ sumlev.summary_level }}" data-plural-name="{{ sumlev.plural_name }}" data-ancestor-list="{{ sumlev.ancestor_sumlev_list }}" data-ancestor-names="{{ sumlev.ancestor_options }}">{{ sumlev.plural_name|capfirst }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="column-three-quarters autocomplete-widget">
            <h2>Within a place</h2>
            <input name="parent_select" id="parent-select" type="text" placeholder="... then search for a place" autocomplete="off">
        </div>
    </section>
    
    <div id="query-release" class="query-chosen">
        <h3 class="leader">Release</h3>
        {{ table.census_release }}
    </div>
    <section id="query-release-picker" class="clearfix">
        <div class="release-option column-third">
            <h3>ACS 2011 1-year</h3>
            <p>
                Data for areas with populations of 65,000+<br>
                Most current, but smallest sample size
            </p>
            <a data-release-slug="acs2011_1yr" href="{% url 'geography_comparison_detail' parent_id descendant_sumlev format %}?release=acs2011_1yr&table={{ table.table_id }}">Show results</a>
        </div>
        <div class="release-option column-third">
            <h3>ACS 2011 3-year</h3>
            <p>
                Data for areas with populations of 20,000+<br>
                Larger sample than 1-year, smaller than 5-year
            </p>
            <a data-release-slug="acs2011_3yr" href="{% url 'geography_comparison_detail' parent_id descendant_sumlev format %}?release=acs2011_3yr&table={{ table.table_id }}">Show results</a>
        </div>
        <div class="release-option column-third">
            <h3>ACS 2011 5-year</h3>
            <p>
                Data for all areas<br>
                Least current, but most reliable
            </p>
            <a data-release-slug="acs2011_5yr" href="{% url 'geography_comparison_detail' parent_id descendant_sumlev format %}?release=acs2011_5yr&table={{ table.table_id }}">Show results</a>
        </div>
    </section>
</section>

<div class="tool-set">
    <div class="tool-group">
        <ul class="toggle-set">
            <li><a class="{% if format == 'table' %}active{% endif %}" href="{% url 'geography_comparison_detail' parent_id descendant_sumlev 'table' %}?{{ request.GET.urlencode }}">Table</a></li>
            <li><a class="{% if format == 'map' %}active{% endif %}" href="{% url 'geography_comparison_detail' parent_id descendant_sumlev 'map' %}?{{ request.GET.urlencode }}">Map</a></li>
            <li><a class="{% if format == 'distribution' %}active{% endif %}" href="{% url 'geography_comparison_detail' parent_id descendant_sumlev 'distribution' %}?{{ request.GET.urlencode }}">Distribution</a></li>
            <li class="toggle-sub-group">
                <a href="#">
                    Download
                </a>
                <ul class="sub-group">
                    <li><a href="{% url 'geography_comparison_detail' parent_id descendant_sumlev 'json' %}?{{ request.GET.urlencode }}">JSON</a></li>
                    <li><a href="{% url 'geography_comparison_detail' parent_id descendant_sumlev 'csv' %}?{{ request.GET.urlencode }}">CSV</a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<h1>Compare {% firstof comparison_metadata.descendant_type.plural comparison_metadata.descendant_type.name %} in {{ comparison_metadata.parent_geography.geography.name }}</h1>
{% endblock %}

{% block body_javascript_extra %}{{ block.super }}
<script>
var currentYear = '2011';
var getCountsAPI = 'http://api.censusreporter.org/1.0/table/compare/rowcounts/' +
                    '{{ table.table_id }}?year=' + currentYear  +
                    '&sumlevel={{ descendant_sumlev }}&within={{ parent_id }}';
                    
function getReleaseCounts() {
    $.getJSON(getCountsAPI)
        .done(function(data) {
            $.each(data, function() {
                if (!!this['results'] && this['results'] > 0) {
                    $("a[data-release-slug='" + this['release_slug'] +"']")
                        .text("Show " + this['results'] + " results");
                } else {
                    $("a[data-release-slug='" + this['release_slug'] +"']")
                        .text("No matching results")
                        .removeAttr("href").addClass("disabled");
                }
            });
        });

}
jQuery(document).ready(function(){
    getReleaseCounts();
    var choosers = $('.query-chosen'),
        pickers = $('section[id$="-picker"]');

    $('#query-builder-bar').on('click', '.query-chosen', function() {
        var chosen = $(this);
        chosen.toggleClass('open').siblings('.query-chosen').removeClass('open');
        pickers.hide();

        if (chosen.hasClass('open')) {
            choosers.addClass('tabbed');
            chosen.next('section').show();
        } else {
            choosers.removeClass('tabbed');
        }
    })
    
    $('.toggle-sub-group').hover(function() {
        $(this).find('.sub-group').toggle();
        $(this).find('a').toggleClass('hovered');
    });
})
</script>
{% endblock %}