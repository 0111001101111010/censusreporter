{% extends '_base_profile.html' %}{% load humanize %}

{% block head_title %}{% firstof geo_place_data.full_name geography.pretty_name geography.name %} - {{ block.super }}{% endblock %}

{% block head_css_extra %}
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->
<link href='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.css' rel='stylesheet' />
  <!--[if lte IE 8]>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.ie.css' rel='stylesheet' >
  <![endif]-->
{% endblock %}

{% block head_javascript_extra %}
{# include in head so it's available throughout body #}
{#}<script src="http://d3js.org/d3.v3.min.js"></script>{#}
<script src="{{ STATIC_URL }}js/vendor/d3.v3.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
<script src='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.js'></script>
{% endblock %}

{% block body_id %}profile{% endblock %}

{% block header %}
<header id="page-header">
    <div id="page-header-title" class="wrapper clearfix">
        <a href="{% url 'homepage' %}">
            <img src="{{ STATIC_URL }}img/logo-badge.png"> CensusReporter
        </a>
    </div>
</header>

<div id="cover-map" class="clearfix">
    <div id="cover-profile" class="wrapper">
        <article class="clearfix column-half">
            <header class="column-full">
                <h1 class="title">{% firstof geo_place_data.full_name geography.pretty_name geography.name %}</h1>
                <p class="caption">Data from {{ geography.census_release }} release unless otherwise noted</p>
            </header>
            <div class="column-half">
                <div class="stat">
                    <span class="primary">
                        <span class="value">{{ geography.total_population|intcomma }}</span>
                        <span class="name">Population</span>
                    </span>
                </div>
            </div>
            {% if geo_metadata.square_miles %}
            <div class="column-half">
                <div class="stat">
                    <span class="secondary">
                        <span class="value">{{ geo_metadata.square_miles|floatformat|intcomma }}</span>
                        <span class="name"> square miles</span>
                    </span>
                    <span class="secondary">
                        <span class="value">{{ geo_metadata.population_density|floatformat|intcomma }}</span>
                        <span class="name"> people per square mile</span>
                    </span>
                </div>
            </div>
            {% endif %}
            <div class="column-full">
                <p>This is some short, generated text that uses the facts and figures below to provide some narrative about the place being profiled.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla sagittis vehicula euismod. In erat quam, dictum eu leo non, euismod pretium diam. Maecenas rutrum dolor at diam placerat aliquam. Aenean rhoncus sapien ac venenatis euismod. Nam id ligula facilisis, placerat erat at, congue diam.</p>
            </div>
        </article>
    </div>

    <div id="slippy-map"></div>
</div>

{% endblock %}

{% block content %}
{#}<p class="explain">Indexes show data as a percentage of state and national values, highlighting values that diverge by at least 20%.</p>{#}

{% comment %}
<article id="demographics" class="clearfix">
    <header class="section-contents">
        <h1>Demographics</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_demographics_age.html" %}

        <section class="clearfix stat-row">
            <aside></aside>
            <div class="column-third">
                <h2 class="column-header">Sex</h2>
                <div id="chart-alt-pie-demographics-sex" data-stat-type="percentage" data-initial-sort="-value"></div>
            </div>
            <div class="column-two-thirds">
                <h2 class="column-header">Race &amp; Ethnicity</h2>
                <div id="chart-column-demographics-race" data-stat-type="percentage"></div>
            </div>
        </section>
    </div>
</article>{% endcomment %}

<article id="demographics" class="clearfix">
    <header class="section-contents">
        <h1>Demographics</h1>
    </header>
    <div class="section-container">
        <section class="clearfix stat-row">
            <h2 class="column-header">Sex</h2>
            <aside></aside>
            <div class="column-quarter">
                <div class="stat">
                    <span class="primary">
                        <span class="value">{{ geography.total_population|intcomma }}</span>
                        <span class="name">Total population</span>
                    </span>
                </div>
                <div class="stat">
                    <span class="secondary">
                        <span class="value">XXX,XXX</span>
                        <span class="name">Male</span>
                    </span>
                </div>
                <div class="stat">
                    <span class="secondary">
                        <span class="value">XXX,XXX</span>
                        <span class="name">Female</span>
                    </span>
                </div>
            </div>
            <div class="column-quarter" id="chart-pie-demographics-sex" data-stat-type="percentage" data-initial-sort="-value"></div>
            <div class="column-half" style="background-color: #eee; height: 140px; padding-top: 50px; text-align: center; color: #aaa;">
                TODO
            </div>
        </section>

        <section class="clearfix">
            <h2 class="column-header">Age</h2>
            <aside>
                {% if sumlev in "040,050" %}
                <h3>Compare</h3>
                <p><a href="{% url 'geography_comparison_detail' state_geoid sumlev 'map' %}">Counties by age group</a></p>
                {% endif %}
            </aside>
            <div class="column-quarter">
                {% include '_profile/_stat_list.html' with stat=demographics.age.median_age stat_type='number' %}
            </div>
            <div class="column-half" id="chart-histogram-demographics-age-population_by_age-total" data-stat-type="scaled-percentage"></div>
            <div class="column-quarter">
                {% include '_profile/_stat_list.html' with stat=demographics.age.percent_under_18 stat_type='percentage' stat_class='secondary' %}
                {% include '_profile/_stat_list.html' with stat=demographics.age.percent_over_65 stat_type='percentage' stat_class='secondary' %}
            </div>
        </section>

        <section class="clearfix stat-row">
            <h2 class="column-header">Race &amp; Ethnicity</h2>
            <aside></aside>
            <div class="column-third">
                {% include '_profile/_stat_list.html' with stat=demographics.race.percent_white stat_type='percentage' %}
            </div>
            <div class="column-two-thirds">
                <div id="chart-column-demographics-race" data-stat-type="percentage"></div>
            </div>
        </section>
    </div>
</article>

<article id="economics" class="clearfix">
    <header class="section-contents">
        <h1>Economics</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_economics_income.html" %}
        {% include "_profile/section_economics_poverty.html" %}
    </div>
</article>

{% comment %}
<article id="education" class="clearfix">
    <header class="section-contents">
        <h1>Education</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_education_attainment.html" %}
    </div>
</article>

<article id="employment" class="clearfix">
    <header class="section-contents">
        <h1>Employment</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_employment_travel.html" %}
    </div>
</article>

<article id="families" class="clearfix">
    <header class="section-contents">
        <h1>Families</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_families_households.html" %}
    </div>
</article>

<article id="housing" class="clearfix">
    <header class="section-contents">
        <h1>Housing</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_housing_housing_units.html" %}
        {% include "_profile/section_housing_tenure_mobility.html" %}
        {% include "_profile/section_housing_value.html" %}
    </div>
</article>

<article id="sociocultural" class="clearfix">
    <header class="section-contents">
        <h1>Socio-cultural</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_sociocultural_place_of_birth.html" %}
        {% include "_profile/section_sociocultural_language.html" %}
    </div>
</article>

<article id="veterans" class="clearfix">
    <header class="section-contents">
        <h1>Veterans</h1>
    </header>
    <div class="section-container">
        {% include "_profile/section_veterans_veteran_status.html" %}
    </div>
</article>
{% endcomment %}
{% endblock %}

{% block body_javascript_extra %}
<script src="{{ STATIC_URL }}js/charts/cr.charts.js"></script>
<script src="{{ STATIC_URL }}js/maps.profile.js"></script>
<script type="text/javascript">

// draw a geom
{% if geo_metadata.geom %}
var featureData = JSON.parse('{% autoescape off %}{{ geo_metadata.geom }}{% endautoescape %}'),
    featureLayer = L.geoJson(featureData, {
        style: {
            "fillColor": "#66c2a5",
            "color": "#777",
            "weight": 2,
            "clickable": false
        }
    });
map.addLayer(featureLayer);
var objBounds = featureLayer.getBounds();

var z;
for(z = 16; z > 2; z--) {
    var swPix = map.project(objBounds.getSouthWest(), z),
        nePix = map.project(objBounds.getNorthEast(), z),
        pixWidth = Math.abs(nePix.x - swPix.x),
        pixHeight = Math.abs(nePix.y - swPix.y);
    if (pixWidth <  500 && pixHeight < 400) {
        break;
    }
}

map.setView(featureLayer.getBounds().getCenter(), z);
map.panBy([-270, 0], {animate: false});
{% endif %}

var Charts = {},
    chartContainers = $('[id^=chart-]'),
    profileData = {{ profile_data_json }};

$.each(chartContainers, function(i) {
    var chartID = $(this).prop('id'),
        chartDataID = chartID.replace('chart-','').replace('alt-','').split('-'),
        chartType = chartDataID[0],
        chartData = profileData[chartDataID[1]],
        chartChartTitle = $(this).data('chart-title');
        chartInitialSort = $(this).data('initial-sort');
        chartStatType = $(this).data('stat-type');

    // allow arbitrary nesting in API data structure
    var drilldown = chartDataID.length - 1;
    if (drilldown >= 2) {
        for (var i = 2; i <= drilldown; i++) {
            chartData = chartData[chartDataID[i]]
        }
    }

    Charts[i] = Chart({
        chartContainer: chartID,
        chartType: chartType,
        chartHeight: 150,
        chartData: chartData,
        chartChartTitle: chartChartTitle,
        chartInitialSort: chartInitialSort,
        chartStatType: chartStatType
    });
});
</script>
{% endblock %}