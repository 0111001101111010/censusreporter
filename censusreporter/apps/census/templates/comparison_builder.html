{% extends '_base.html' %}{% load humanize %}

{% block head_title %}Comparison Query Builder - {{ block.super }}{% endblock %}

{% block head_extra_css %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/select2/select2.textinput.css">
{% endblock %}

{% block content %}
<article class="clearfix">
    <section id="query-builder" class="clearfix">
        <form action="" method="GET" onsubmit="return false">
            <section class="clearfix" id="topic-chosen"></section>
            <section class="clearfix" id="topic-picker">
                <div class="column-golden-wide">
                    <h2>Filter your data search by topic</h2>
                    <h5>Demographics</h5>
                    <ul class="filter-list clearfix">
                        {% for topic in topic_demographic_filters.topics %}
                        <li class="column-quarter"><input type="checkbox" id="topic-select-{{ topic|slugify }}" value="{{ topic }}"> <label for="topic-select-{{ topic|slugify }}">{{ topic }}</label></li>
                        {% endfor %}
                    </ul>

                    <h5>Economic</h5>
                    <ul class="filter-list clearfix">
                        {% for topic in topic_economic_filters.topics %}
                        <li class="column-quarter"><input type="checkbox" id="topic-select-{{ topic|slugify }}" value="{{ topic }}"> <label for="topic-select-{{ topic|slugify }}">{{ topic }}</label></li>
                        {% endfor %}
                    </ul>

                    <h5>Housing</h5>
                    <ul class="filter-list clearfix">
                        {% for topic in topic_housing_filters.topics %}
                        <li class="column-quarter"><input type="checkbox" id="topic-select-{{ topic|slugify }}" value="{{ topic }}"> <label for="topic-select-{{ topic|slugify }}">{{ topic }}</label></li>
                        {% endfor %}
                    </ul>

                    <h5>Social</h5>
                    <ul class="filter-list clearfix">
                        {% for topic in topic_social_filters.topics %}
                        <li class="column-quarter"><input type="checkbox" id="topic-select-{{ topic|slugify }}" value="{{ topic }}"> <label for="topic-select-{{ topic|slugify }}">{{ topic }}</label></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="column-golden-narrow autocomplete-widget">
                    <h2>Search <span id="table-number"></span> data tables</h2>
                    <input name="topic_select" id="topic-select" type="text" placeholder="Search for data..." autocomplete="off">
                </div>
            </section>

            <section class="clearfix" id="geographies-chosen"></section>
            <section class="clearfix" id="geography-picker">
                <div class="column-golden-wide" id="sumlev-select-options">
                    <h2>Compare geographies</h2>
                    <h5>Standard</h5>
                    <ul class="filter-list clearfix">
                        {% for summary_level in sumlev_standard_choices %}
                        <li class="column-quarter"><input type="radio" name="sumlev_select" id="sumlev-select-{{ summary_level.summary_level }}" value="{{ summary_level.summary_level }}" data-plural-name="{{ summary_level.plural_name }}" data-ancestor-list="{{ summary_level.ancestor_sumlev_list }}" data-ancestor-names="{{ summary_level.ancestor_options }}"> <label for="sumlev-select-{{ summary_level.summary_level }}">{{ summary_level.plural_name|capfirst }}</label></li>
                        {% endfor %}
                    </ul>

                    <h5>Legislative</h5>
                    <ul class="filter-list clearfix">
                        {% for summary_level in sumlev_legislative_choices %}
                        <li class="column-third"><input type="radio" name="sumlev_select" id="sumlev-select-{{ summary_level.summary_level }}" value="{{ summary_level.summary_level }}" data-ancestor-list="{{ summary_level.ancestor_sumlev_list }}" data-ancestor-names="{{ summary_level.ancestor_options }}"> <label for="sumlev-select-{{ summary_level.summary_level }}">{{ summary_level.plural_name|capfirst }}</label></li>
                        {% endfor %}
                    </ul>

                    <h5>Schools</h5>
                    <ul class="filter-list clearfix">
                        {% for summary_level in sumlev_school_choices %}
                        <li class="column-third"><input type="radio" name="sumlev_select" id="sumlev-select-{{ summary_level.summary_level }}" value="{{ summary_level.summary_level }}" data-ancestor-list="{{ summary_level.ancestor_sumlev_list }}" data-ancestor-names="{{ summary_level.ancestor_options }}"> <label for="sumlev-select-{{ summary_level.summary_level }}">{{ summary_level.plural_name|capfirst }}</label></li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="column-golden-narrow autocomplete-widget">
                    <h2>Within a place</h2>
                    <input name="parent_select" id="parent-select" type="text" placeholder="Search for place..." autocomplete="off">
                </div>
            </section>
        </form>
    </section>
    
    <section id="results-container" class="clearfix">
        <textarea id="results"></textarea>
    </section>
</article>
{% endblock %}

{% block body_javascript_extra %}
<script src="{{ STATIC_URL }}js/vendor/typeahead.js"></script>
<script src="{{ STATIC_URL }}js/vendor/hogan-2.0.0.js"></script>
<script src="{{ STATIC_URL }}js/vendor/spin.min.js"></script>
<script type="text/javascript">
var tableSearchAPI = '/table-search/json/',
    parentGeoSearchAPI = '/place-search/json/';

var topicSelect = $('#topic-select'),
    topicChosen = $('#topic-chosen'),
    topicFilters = $('#topic-picker .filter-list input:checkbox'),
    sumlevSelect = $('#sumlev-select-options input'),
    parentSelect = $('#parent-select'),
    geographiesChosen = $('#geographies-chosen');

var parentDisabled = true;

var selectedTopicFilterValues = function (){
    var values = topicFilters.filter(':checked').map(function () {
        return this.value;
    }).get();
    return values
}

var selectedSumlevAncestorValues = function (){
    var values = sumlevSelect.filter(':checked').data('ancestor-list');
    return values
}

var selectedSumlev = function (){
    return sumlevSelect.filter(':checked')
}

function makeTopicSelectWidget(element, helpText) {
    element.typeahead('destroy');
    element.typeahead({
        name: 'topics',
        remote: {
            url: tableSearchAPI,
            replace: function (url, uriEncodedQuery) {
                url += '?q=' + uriEncodedQuery + '&topics=' + selectedTopicFilterValues().join(',');
                return url
            }
        },
        limit: 20,
        template: [
            {% verbatim %}'<h5 class="result-type">Table {{table_id}}</h5>',
            '<p class="result-name">{{value}}</p>',
            '<p class="caption"><strong>Topics:</strong> {{topics}}</p>'{% endverbatim %}
        ].join(''),
        engine: Hogan
    });
     
    element.on('typeahead:selected', function(obj, datum) {
        element.data('table-id', datum['table_id']);
        var chosenText = '<span class="leader">Data table ' + datum['table_id'] + ':</span> ' + datum['table_name'];
        updateChosenItem(topicChosen, chosenText)
        makeAPIRequest();
    });

    topicFilters.on('change', function(e) {
        getTableNumber();
        element.typeahead('setQuery',element.val());
        element.focus();
    });

    if (!!helpText) {
        insertHelpText(element.parent(), helpText);
    }
}

function makeParentSelectWidget(element, helpText) {
    element.typeahead('destroy');
    element.prop('disabled', 'disabled');
    element.typeahead({
        name: 'geographies',
        valueKey: 'full_name',
        remote: {
            url: parentGeoSearchAPI,
            replace: function (url, uriEncodedQuery) {
                url += '?q=' + uriEncodedQuery + '&sumlev_filter=' + selectedSumlevAncestorValues();
                return url
            }
        },
        limit: 20,
        template: [
            {% verbatim %}'<h5 class="result-type">GeoID {{full_geoid}}</h5>',
            '<p class="result-name">{{full_name}}</p>'{% endverbatim %}
        ].join(''),
        engine: Hogan
    });
     
    element.on('typeahead:selected', function(obj, datum) {
        element.data('parent-geoid', datum['full_geoid']);
        var chosenText = '<span class="leader">Geographies:</span> All <strong>' + selectedSumlev().data('plural-name') + '</strong> within <strong>' + datum['full_name'] + '</strong>';
        updateChosenItem(geographiesChosen, chosenText)
        makeAPIRequest();
    });
    
    // when user chooses a sumlev to compare, limit possible
    // autocomplete options for parent/containing geography
    sumlevSelect.on('change', function(e) {
        element.removeProp('disabled').siblings('.help-text').remove();
        
        if (this.checked) {
            var selected = $(this);
            var ancestorNameList = selected.data('ancestor-names');
            var helpText = selected.next('label').text() + ' can be compared within a ' + ancestorNameList + '.';
            insertHelpText(element.parent(), helpText);
        }
    });
}

function insertHelpText(element, message) {
    var helpText = $('<span class="help-text">' + message + '</span>').css('width', element.width());
    element.append(helpText);
}

function updateChosenItem(element, itemText) {
    var html = [
        '<a href="#" class="change-choice">Change</a>',
        '<p>' + itemText + '</p>'
    ].join('');

    element.html(html).addClass('chosen').fadeIn('fast');
    element.next('section').fadeOut('fast');
}

function changeChosenItem(element) {
    var element = $(element);
    element.fadeOut('fast').html('').removeClass('chosen');
    element.next('section').fadeIn('fast');
}

function makeAPIRequest() {
    var tableID = topicSelect.data('table-id'),
        parentGeoID = parentSelect.data('parent-geoid'),
        sumlev = selectedSumlev().val();
        
    console.log(tableID, parentGeoID, sumlev);
        
    if (!!tableID && !!parentGeoID && !!sumlev) {
        // get rowcounts from each of the current ACS releases
        // for this table/sumlev/parent combination
        var currentYear = '2011';
        var getCountsAPI = 'http://api.censusreporter.org/1.0/table/compare/rowcounts/' +
                            tableID + '?year=' + currentYear  + '&sumlevel=' + sumlev +
                            '&within=' + parentGeoID;
        
        counts = fetchAPIData(getCountsAPI);
        
        // 
        
        // choose the release with the most results and fetch that data
        if (!!release) {
            // get the whole table even if they've chosen a column
            // TODO: decide whether this is better (provides context),
            // or whether we should just get the table
            var getDataAPI = 'http://api.censusreporter.org/1.0/data/compare/' +
                              release + '/' + tableID + '?sumlevel=' + sumlev +
                              '&within=' + parentGeoID + '&geom=true';

            data = fetchAPIData(getDataAPI);
        }
    }
}

function fetchAPIData(requestURL) {
    var target = document.getElementById('results-container');
    var spinner = new Spinner().spin(target);
    
    $.ajax({
        type: 'GET',
        url: requestURL,
        dataType: 'json',
        success: function(data) {
            //var strData = (JSON.stringify(data, null, 4));
            //$('#results').text(strData).fadeIn('fast');
            spinner.stop();
            return data
        },
        error: function(response) {
            alert('Uh-oh, something went wrong.');
            return false
        }
    });
}

function getTableNumber(requestURL) {
    var target = document.getElementById('table-number');
    
    $.ajax({
        type: 'GET',
        url: tableSearchAPI,
        data: {
            topics: selectedTopicFilterValues().join(','),
            count: 'tables'
        },
        dataType: 'json',
        success: function(data) {
            $(target).text(data['count']);
        }
    });
}

jQuery(document).ready(function(){
    $('#results').hide();
    
    // initial setup for select widgets
    getTableNumber();
    makeTopicSelectWidget(topicSelect);
    makeParentSelectWidget(parentSelect, parentDisabled);
    
    // on page load, reset selects because if browser happens
    // to hold onto value it won't trigger the sumlev filter
    parentSelect.val('');
    sumlevSelect.removeAttr('checked');
    
    $('#query-builder').on('click', '.chosen', function(e) {
        e.preventDefault();
        changeChosenItem($(this));
    });
    
})
</script>
{% endblock %}